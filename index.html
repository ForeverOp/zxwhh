<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Poki 3D Shooter FINAL</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
body{margin:0;overflow:hidden;background:#000;font-family:Arial}
#hud{position:fixed;top:10px;left:10px;color:#fff;font-size:18px}
.btn{
  position:fixed;
  width:90px;height:90px;border-radius:50%;
  background:rgba(255,255,255,.25);
  border:3px solid #fff;
}
#shoot{right:20px;bottom:80px}
#up{left:80px;bottom:200px}
#down{left:80px;bottom:40px}
#left{left:10px;bottom:120px}
#right{left:150px;bottom:120px}
</style>
</head>
<body>

<div id="hud">Vida: <span id="hp">100</span></div>

<div class="btn" id="shoot"></div>
<div class="btn" id="up"></div>
<div class="btn" id="down"></div>
<div class="btn" id="left"></div>
<div class="btn" id="right"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script>
let scene,camera,renderer,ground;
let player,gun;
let bullets=[],enemyBullets=[],enemies=[];
let hp=100;

// CONTROLE
let yaw=0,pitch=0;
let move={f:0,b:0,l:0,r:0};

// RAYCAST
const raycaster=new THREE.Raycaster();
const down=new THREE.Vector3(0,-1,0);

init();
animate();

function init(){
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x87ceeb);

  camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.1,500);

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth,innerHeight);
  document.body.appendChild(renderer.domElement);

  scene.add(new THREE.AmbientLight(0xffffff,.7));
  let sun=new THREE.DirectionalLight(0xffffff,1);
  sun.position.set(100,200,100);
  scene.add(sun);

  // MAPA MONTANHA
  let geo=new THREE.PlaneGeometry(300,300,70,70);
  geo.rotateX(-Math.PI/2);
  for(let i=0;i<geo.attributes.position.count;i++){
    geo.attributes.position.setY(i,Math.random()*6);
  }
  geo.computeVertexNormals();
  ground=new THREE.Mesh(
    geo,
    new THREE.MeshStandardMaterial({color:0x3a7d44})
  );
  scene.add(ground);

  // PLAYER MANEQUIM
  player=new THREE.Group();
  let body=new THREE.Mesh(
    new THREE.BoxGeometry(1.5,2.5,1),
    new THREE.MeshStandardMaterial({color:0xaaaaaa})
  );
  body.position.y=1.5;
  let head=new THREE.Mesh(
    new THREE.BoxGeometry(1.2,1.2,1.2),
    new THREE.MeshStandardMaterial({color:0xcccccc})
  );
  head.position.y=3;
  player.add(body,head);
  player.position.set(0,20,0);
  scene.add(player);

  // ARMA
  gun=new THREE.Mesh(
    new THREE.BoxGeometry(.3,.3,1.2),
    new THREE.MeshStandardMaterial({color:0x222})
  );
  gun.position.set(.9,1.8,.5);
  player.add(gun);

  for(let i=0;i<6;i++) spawnEnemy();

  bind("up",()=>move.f=1,()=>move.f=0);
  bind("down",()=>move.b=1,()=>move.b=0);
  bind("left",()=>move.l=1,()=>move.l=0);
  bind("right",()=>move.r=1,()=>move.r=0);
  document.getElementById("shoot").ontouchstart=shoot;

  // CÂMERA 360°
  let lx=0,ly=0;
  addEventListener("touchstart",e=>{
    lx=e.touches[0].clientX;
    ly=e.touches[0].clientY;
  });
  addEventListener("touchmove",e=>{
    let dx=e.touches[0].clientX-lx;
    let dy=e.touches[0].clientY-ly;
    yaw-=dx*0.004;
    pitch-=dy*0.004;
    pitch=Math.max(-1.2,Math.min(1.2,pitch));
    lx=e.touches[0].clientX;
    ly=e.touches[0].clientY;
  });

  addEventListener("resize",resize);
}

function bind(id,on,off){
  let b=document.getElementById(id);
  b.ontouchstart=on;
  b.ontouchend=off;
}

function stickToGround(obj){
  raycaster.set(obj.position.clone().add(new THREE.Vector3(0,10,0)),down);
  let hit=raycaster.intersectObject(ground);
  if(hit.length) obj.position.y=hit[0].point.y;
}

function spawnEnemy(){
  let e=new THREE.Group();
  let b=new THREE.Mesh(
    new THREE.BoxGeometry(1.5,2.5,1),
    new THREE.MeshStandardMaterial({color:0xff4444})
  );
  b.position.y=1.5;
  let h=new THREE.Mesh(
    new THREE.BoxGeometry(1.2,1.2,1.2),
    new THREE.MeshStandardMaterial({color:0xff7777})
  );
  h.position.y=3;
  e.add(b,h);
  e.position.set((Math.random()-0.5)*80,30,(Math.random()-0.5)*80);
  e.cool=0;
  scene.add(e);
  enemies.push(e);
}

function shoot(){
  let b=new THREE.Mesh(
    new THREE.SphereGeometry(.15),
    new THREE.MeshBasicMaterial({color:0xffff00})
  );
  b.position.copy(player.position);
  b.vel=new THREE.Vector3(
    Math.sin(yaw)*Math.cos(pitch),
    Math.sin(pitch),
    Math.cos(yaw)*Math.cos(pitch)
  ).multiplyScalar(1);
  scene.add(b);
  bullets.push(b);
}

function enemyShoot(e){
  let b=new THREE.Mesh(
    new THREE.SphereGeometry(.15),
    new THREE.MeshBasicMaterial({color:0xff8800})
  );
  b.position.copy(e.position);
  b.vel=player.position.clone().sub(e.position).normalize().multiplyScalar(.5);
  scene.add(b);
  enemyBullets.push(b);
}

function animate(){
  requestAnimationFrame(animate);

  let forward=new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
  let side=new THREE.Vector3(Math.cos(yaw),0,-Math.sin(yaw));

  if(move.f) player.position.add(forward.clone().multiplyScalar(.25));
  if(move.b) player.position.add(forward.clone().multiplyScalar(-.25));
  if(move.l) player.position.add(side.clone().multiplyScalar(-.25));
  if(move.r) player.position.add(side.clone().multiplyScalar(.25));

  stickToGround(player);
  player.rotation.y=yaw;

  camera.position.copy(player.position).add(
    new THREE.Vector3(
      -Math.sin(yaw)*6,
      4+pitch*2,
      -Math.cos(yaw)*6
    )
  );
  camera.lookAt(player.position.clone().add(new THREE.Vector3(0,2,0)));

  bullets.forEach(b=>b.position.add(b.vel));
  enemyBullets.forEach(b=>b.position.add(b.vel));

  enemies.forEach(e=>{
    stickToGround(e);
    if(e.position.distanceTo(player.position)<40){
      e.lookAt(player.position);
      if(e.cool<=0){enemyShoot(e);e.cool=90;}
    }
    e.cool--;
  });

  renderer.render(scene,camera);
}

function resize(){
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
}
</script>
</body>
</html>
