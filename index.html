<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>3D Shooter Analógico</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
body{margin:0;overflow:hidden;background:#000;font-family:Arial}
#hud{position:fixed;top:10px;left:10px;color:#fff;font-size:18px}
.crosshair{position:fixed;top:50%;left:50%;width:20px;height:20px;margin:-10px 0 0 -10px;border:2px solid #fff;border-radius:50%;}
#shoot{position:fixed;width:80px;height:80px;border-radius:50%;background:rgba(255,255,255,.25);border:3px solid #fff;right:20px;bottom:80px;}
#joystickOuter{position:fixed;width:150px;height:150px;border-radius:50%;background:rgba(255,255,255,.2);left:20px;bottom:50px;}
#joystickInner{position:absolute;width:70px;height:70px;border-radius:50%;background:rgba(255,255,255,.5);left:40px;top:40px;}
</style>
</head>
<body>
<div id="hud">Vida: <span id="hp">100</span></div>
<div class="crosshair"></div>
<div id="shoot"></div>
<div id="joystickOuter"><div id="joystickInner"></div></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script>
let scene,camera,renderer;
let player,gun;
let bullets=[],enemyBullets=[],enemies=[];
let hp=100;
let yaw=0,pitch=0;
let move={f:0,b:0,l:0,r:0};
const raycaster=new THREE.Raycaster();
const down=new THREE.Vector3(0,-1,0);
let chunks={},chunkSize=50,loadedChunks={},house;

// ANALÓGICO
let joyOuter=document.getElementById("joystickOuter");
let joyInner=document.getElementById("joystickInner");
let joyCenter={x:75,y:75};
let joyDelta={x:0,y:0};
let touching=false;

init();
animate();

function init(){
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x87ceeb);
  camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.1,1000);
  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth,innerHeight);
  document.body.appendChild(renderer.domElement);
  scene.add(new THREE.AmbientLight(0xffffff,.7));
  let sun=new THREE.DirectionalLight(0xffffff,1);
  sun.position.set(100,200,100);
  scene.add(sun);

  // PLAYER
  player=new THREE.Group();
  let body=new THREE.Mesh(new THREE.BoxGeometry(1.5,2.5,1),new THREE.MeshStandardMaterial({color:0xaaaaaa}));
  body.position.y=1.5;
  let head=new THREE.Mesh(new THREE.BoxGeometry(1.2,1.2,1.2),new THREE.MeshStandardMaterial({color:0xcccccc}));
  head.position.y=3;
  player.add(body,head);
  player.position.set(0,20,0);
  scene.add(player);

  gun=new THREE.Mesh(new THREE.BoxGeometry(.3,.3,1.2),new THREE.MeshStandardMaterial({color:0x222}));
  gun.position.set(.9,1.8,.5);
  player.add(gun);

  // INIMIGOS
  for(let i=0;i<6;i++) spawnEnemy();

  document.getElementById("shoot").ontouchstart=shoot;

  // CÂMERA 360°
  let lx=0,ly=0;
  addEventListener("touchstart",e=>{
    for(let t of e.touches){if(t.target==joyInner)return;}
    lx=e.touches[0].clientX; ly=e.touches[0].clientY;
  });
  addEventListener("touchmove",e=>{
    for(let t of e.touches){if(t.target==joyInner)return;}
    let dx=e.touches[0].clientX-lx;
    let dy=e.touches[0].clientY-ly;
    yaw-=dx*0.004;
    pitch-=dy*0.004;
    pitch=Math.max(-1.2,Math.min(1.2,pitch));
    lx=e.touches[0].clientX; ly=e.touches[0].clientY;
  });

  // ANALÓGICO
  joyOuter.addEventListener("touchstart",e=>{touching=true;});
  joyOuter.addEventListener("touchend",e=>{touching=false; joyInner.style.left="40px"; joyInner.style.top="40px";});
  joyOuter.addEventListener("touchmove",e=>{
    if(!touching)return;
    let t=e.touches[0];
    let rect=joyOuter.getBoundingClientRect();
    let x=t.clientX-rect.left;
    let y=t.clientY-rect.top;
    let dx=x-joyCenter.x;
    let dy=y-joyCenter.y;
    let dist=Math.sqrt(dx*dx+dy*dy);
    let max=60; if(dist>max){dx*=max/dist; dy*=max/dist;}
    joyInner.style.left=40+dx+"px"; joyInner.style.top=40+dy+"px";
    joyDelta.x=dx/60; joyDelta.y=-dy/60; // y invertido
  });

  addEventListener("resize",()=>{camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight);});
}

// BIND
function spawnEnemy(){
  let e=new THREE.Group();
  let b=new THREE.Mesh(new THREE.BoxGeometry(1.5,2.5,1),new THREE.MeshStandardMaterial({color:0xff4444}));
  b.position.y=1.5;
  let h=new THREE.Mesh(new THREE.BoxGeometry(1.2,1.2,1.2),new THREE.MeshStandardMaterial({color:0xff7777}));
  h.position.y=3;
  e.add(b,h);
  e.position.set((Math.random()-0.5)*80,50,(Math.random()-0.5)*80);
  e.cool=0;
  e.hp=20;
  scene.add(e);
  enemies.push(e);
}

function shoot(){
  let b=new THREE.Mesh(new THREE.SphereGeometry(.15),new THREE.MeshBasicMaterial({color:0xffff00}));
  b.position.copy(player.position);
  b.vel=new THREE.Vector3(Math.sin(yaw)*Math.cos(pitch),Math.sin(pitch),Math.cos(yaw)*Math.cos(pitch)).multiplyScalar(1.5);
  scene.add(b);
  bullets.push(b);
}

// COLISÃO E MOVIMENTO
function stickToGround(obj){
  raycaster.set(obj.position.clone().add(new THREE.Vector3(0,20,0)),down);
  let hit=Object.values(loadedChunks).map(c=>raycaster.intersectObject(c)).flat();
  if(hit.length) obj.position.y=hit[0].point.y;
}

function generateChunk(x,z){
  let geo=new THREE.PlaneGeometry(50,50,10,10);
  geo.rotateX(-Math.PI/2);
  for(let i=0;i<geo.attributes.position.count;i++){geo.attributes.position.setY(i,Math.random()*6);}
  geo.computeVertexNormals();
  let mesh=new THREE.Mesh(geo,new THREE.MeshStandardMaterial({color:0x3a7d44}));
  mesh.position.set(x,0,z);
  scene.add(mesh);
  loadedChunks[`${x}_${z}`]=mesh;
  if(!house && Math.random()<0.2){
    house=new THREE.Group();
    let base=new THREE.Mesh(new THREE.BoxGeometry(5,3,5),new THREE.MeshStandardMaterial({color:0x996633}));
    base.position.y=1.5;
    let roof=new THREE.Mesh(new THREE.ConeGeometry(3,2,4),new THREE.MeshStandardMaterial({color:0xaa0000}));
    roof.position.y=4;
    house.add(base,roof);
    house.position.set(x,0,z);
    scene.add(house);
  }
}

function updateChunks(){
  let cx=Math.floor(player.position.x/50)*50;
  let cz=Math.floor(player.position.z/50)*50;
  for(let dx=-2;dx<=2;dx++){
    for(let dz=-2;dz<=2;dz++){
      let key=`${cx+dx*50}_${cz+dz*50}`;
      if(!loadedChunks[key]) generateChunk(cx+dx*50,cz+dz*50);
    }
  }
}

// ANIMATE
function animate(){
  requestAnimationFrame(animate);

  // MOVIMENTO ANALÓGICO
  let forward=new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
  let side=new THREE.Vector3(Math.cos(yaw),0,-Math.sin(yaw));
  if(Math.abs(joyDelta.y)>0.05) player.position.add(forward.clone().multiplyScalar(joyDelta.y*0.3));
  if(Math.abs(joyDelta.x)>0.05) player.position.add(side.clone().multiplyScalar(joyDelta.x*0.3));

  stickToGround(player);
  player.rotation.y=yaw;

  camera.position.copy(player.position).add(new THREE.Vector3(-Math.sin(yaw)*6,4+pitch*2,-Math.cos(yaw)*6));
  camera.lookAt(player.position.clone().add(new THREE.Vector3(0,2,0)));

  // COLISÃO TIROS PLAYER
  bullets.forEach((b,i)=>{
    b.position.add(b.vel);
    enemies.forEach((e,ei)=>{
      if(b.position.distanceTo(e.position)<1.5){
        e.hp-=10; scene.remove(b); bullets.splice(i,1);
        if(e.hp<=0){scene.remove(e); enemies.splice(ei,1); spawnEnemy();}
      }
    });
  });

  // COLISÃO TIROS INIMIGOS
  enemyBullets.forEach((b,i)=>{
    b.mesh.position.add(b.mesh.vel);
    if(b.mesh.position.distanceTo(player.position)<1){
      hp-=5; document.getElementById("hp").textContent=hp; scene.remove(b.mesh); enemyBullets.splice(i,1);
      if(hp<=0) location.reload();
    }
  });

  // INIMIGOS
  enemies.forEach(e=>{
    stickToGround(e);
    if(e.position.distanceTo(player.position)<40){
      e.lookAt(player.position);
      if(e.cool<=0){enemyShoot(e); e.cool=90;}
    }
    e.cool--;
  });

  updateChunks();
  renderer.render(scene,camera);
}

// TIROS INIMIGOS
function enemyShoot(e){
  let b=new THREE.Mesh(new THREE.SphereGeometry(.15),new THREE.MeshBasicMaterial({color:0xff8800}));
  b.position.copy(e.position);
  b.vel=player.position.clone().sub(e.position).normalize().multiplyScalar(.8);
  scene.add(b);
  enemyBullets.push({mesh:b,owner:e});
}
</script>
</body>
</html>
